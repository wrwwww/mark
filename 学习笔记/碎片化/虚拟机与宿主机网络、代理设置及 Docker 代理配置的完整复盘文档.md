# 虚拟机与宿主机网络代理及 Docker 代理配置复盘文档

## 一、背景介绍

在使用虚拟机（如 VirtualBox）时，虚拟机网络通常采用 NAT 模式，宿主机提供网络出口。虚拟机内部访问互联网需要经过宿主机，若宿主机挂载代理（如 Clash、Shadowsocks），虚拟机也需配置相应代理才能正常访问外网资源。Docker 作为容器管理平台，其守护进程默认不使用环境变量代理，需要单独配置。

---

## 二、虚拟机网络环境和宿主机地址识别

- **虚拟机 NAT 模式**下，宿主机在虚拟机内的默认网关 IP 是 `10.0.2.2`（VirtualBox 默认配置）。
    
- 虚拟机内部访问宿主机的代理服务，可以通过该 IP 地址进行访问。
    
- 通过命令 `ip route` 或 `route -n` 可以确认默认网关。
    

---

## 三、虚拟机中设置代理环境变量

1. 设置 HTTP/HTTPS 代理环境变量：
    

```bash
export HTTP_PROXY=http://10.0.2.2:7897
export HTTPS_PROXY=http://10.0.2.2:7897
export NO_PROXY=localhost,127.0.0.1
```

2. 验证代理是否生效：
    

- **注意**：`ping` 命令不走 HTTP 代理，ping 不通谷歌不代表代理无效。
    
- 使用 `curl` 测试访问外网：
    

```bash
curl -v https://www.google.com
```

- 成功建立代理连接且返回正常 HTTP 响应即为代理正常。
    

---

## 四、宿主机代理服务确认

- 确认宿主机代理软件（如 Clash）正常运行且监听正确端口（如 7897）。
    
- 使用 `telnet 10.0.2.2 7897` 或 `nc -zv 10.0.2.2 7897` 测试端口连通性。
    
- 确认防火墙规则未阻挡虚拟机访问该端口。
    

---

## 五、Docker 代理配置

### 1. 问题说明

Docker CLI 与 Docker 守护进程（daemon）是分开的进程。CLI 可以使用环境变量代理，但 daemon 拉取镜像需要单独配置代理，否则拉取失败。

### 2. 配置 Docker daemon 代理

- 在 Linux 系统中，创建或编辑 `/etc/systemd/system/docker.service.d/http-proxy.conf` 文件，内容示例：
    

```ini
[Service]
Environment="HTTP_PROXY=http://10.0.2.2:7897/"
Environment="HTTPS_PROXY=http://10.0.2.2:7897/"
Environment="NO_PROXY=localhost,127.0.0.1"
```

- 重新加载 systemd 配置并重启 Docker 服务：
    

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

- 确认代理环境变量生效：
    

```bash
sudo systemctl show --property=Environment docker
```

### 3. Docker 客户端代理配置（可选）

- 在用户目录下编辑 `~/.docker/config.json`，配置代理字段。
    

---

## 六、网络与安全配置确认

- 确保虚拟机网络模式正确（NAT 或桥接，根据需求）。
    
- 确认宿主机防火墙允许虚拟机访问代理端口。
    
- 确认代理服务支持 HTTP/HTTPS 协议，符合 Docker 和 curl 等客户端需求。
    

---

## 七、验证和排查

- 代理环境变量在虚拟机 shell 生效，可用 `echo $HTTP_PROXY` 验证。
    
- 使用 `curl` 访问测试网页验证代理链路。
    
- 使用 `docker pull` 命令测试镜像拉取是否成功。
    
- 结合 Docker daemon 日志查看代理相关错误。
    

---

## 八、总结

- 虚拟机 NAT 网络环境中，宿主机 IP 一般为 `10.0.2.2`，代理端口需映射和开放。
    
- 虚拟机内部配置环境变量实现 HTTP/HTTPS 代理。
    
- Docker 守护进程需要单独配置代理环境变量，保证镜像拉取成功。
    
- `ping` 不走代理，无法用于测试代理连通性。
    
- 使用 `curl` 和 `docker pull` 是测试代理配置的有效手段。
    

---

这份复盘文档总结了从宿主机代理配置到虚拟机内网络代理设置，再到 Docker 守护进程代理的全流程，便于后续快速排查和配置。你可以把它保存下来，作为网络代理配置的参考。需要补充或者细化的部分，随时告诉我。
好的，我帮你把我们后面这几次关于网络的讨论整理成一篇完整的复盘文档，涵盖 NAT、IP 绑定、路由器端口转换、TCP/UDP 端口独立性等内容。

---

## **网络原理复盘文档**

### 1. NAT 与宿主机 IP

在 VirtualBox 或其他虚拟化软件的 **NAT 模式** 中：

- 虚拟机内部看到的网关 IP 通常是 `10.0.2.2`（这是宿主机的 NAT 代理地址）。
    
- 虚拟机要访问宿主机上的服务，可以通过这个地址，但前提是**宿主机服务监听的是可访问的地址**，而不是仅限 `127.0.0.1`。
    

如果宿主机上的服务只绑定在：

- `127.0.0.1`：只能本机访问，虚拟机和局域网设备都访问不了。
    
- `0.0.0.0` 或实际局域网 IP：局域网和虚拟机才能访问。
    

---

### 2. IP 绑定与可访问性

- **127.0.0.1 / localhost**  
    只绑定到本地回环接口，其他设备（包括局域网和虚拟机）无法访问。
    
- **192.168.x.x（局域网 IP）**  
    绑定到局域网网卡，局域网设备可以访问，但虚拟机 NAT 模式下不一定能直接访问（取决于转发规则）。
    
- **0.0.0.0**  
    绑定到所有可用网卡接口，相当于同时监听本地回环、局域网、虚拟机虚拟网卡等。  
    常见于服务需要被内网和外网同时访问的情况。
    

---

### 3. Vite 的监听行为

Vite 在开发模式下通常会绑定 **0.0.0.0**，这样可以：

- 从本机用 `localhost` 访问（回环接口）。
    
- 从局域网 IP 访问（内网接口）。
    
- 从虚拟机访问（虚拟网卡接口）。
    

因此 Vite 会同时打印两种地址：

- `127.0.0.1:xxxx` → 本机访问
    
- `192.168.x.x:xxxx` → 局域网访问
    

---

### 4. 数据包在路由器的变化

当你电脑的数据包通过路由器访问互联网时：

1. **源 IP**：从局域网 IP（如 `192.168.0.13`）变成路由器的公网 IP。
    
2. **源端口**：为了区分局域网中不同设备/连接，路由器会给每条连接分配一个**新的源端口**（NAT 映射）。
    
3. 路由器维护一个 **NAT 表**，记录：
    
    ```
    内网设备 IP:端口 <-> 公网 IP:新端口
    ```
    
4. 返回数据包时，路由器查 NAT 表，找到对应的内网设备，把数据包转回去。
    

---

### 5. 多个设备访问同一服务器

如果局域网内两个设备都访问同一外部服务器（比如 8.8.8.8:53）：

- 路由器会给它们分配不同的公网端口映射：
    
    ```
    192.168.0.13:52001 <-> 公网IP:40010
    192.168.0.14:52001 <-> 公网IP:40011
    ```
    
- 这样即使两个设备访问同一外部端口，也能通过端口转换区分。
    

---

### 6. 端口数量与限制

- 端口是 16 位整数，范围 1~65535。
    
- NAT 端口映射是 **TCP 和 UDP 分别维护**，互不影响。
    
    - 你可以有 TCP 80 和 UDP 80 同时使用，且不会冲突。
        
- 理论上，每种协议可用的同时连接数上限约为 **65535**，但实际上会受系统资源和 NAT 会话表大小限制。
    

---

### 7. 总结要点

1. **127.0.0.1** 只能本机访问；**192.168.x.x** 可被局域网访问；**0.0.0.0** 绑定所有网卡。
    
2. 虚拟机 NAT 模式中，宿主机的 NAT IP 通常是 `10.0.2.2`。
    
3. 路由器 NAT 通过端口映射区分不同设备的连接。
    
4. TCP 和 UDP 各自有独立的 65535 个端口空间。
    
5. 开发调试时，如果要让局域网或虚拟机访问，绑定 `0.0.0.0` 是最通用的方法。
    

---

我可以帮你在这篇文档后面画一张 **NAT 转换 + IP 绑定可访问性** 的可视化图，能更直观地理解这些内容。  
这样你一看图就能想起来整个过程。你要我加上吗？